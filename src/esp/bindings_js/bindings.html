<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Habitat</title>
  <link rel="stylesheet" href="WebApplication.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
  <h1>Habitat</h1>
  <div id="container">
    <div id="sizer">
      <div id="expander">
        <div id="listener">
          <canvas id="canvas"></canvas>
          <canvas id="canvas2d" width="640" height="480"></canvas>
          <pre id="log"></pre>
          <div id="status">Initialization...</div>
          <div id="status-description"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.1.0/async.min.js"></script>
  <script src="navigate.js"></script>
  <script src="simenv_embind.js"></script>
  <script src="WindowlessEmscriptenApplication.js"></script>
  <script async src="hsim_bindings.js"></script>
  <script>
    Module["onRuntimeInitialized"] = function() {
      console.log("hsim_bindings initialized");

      const sensorConfigJson = [{
        name: 'rgba_camera',
        resolution: [640, 480]
      }];
      const agentConfigJson = [ {
        height: 1.5,
        radius: 0.1,
        mass: 32.0,
        linearAcceleration: 20.0,
        angularAcceleration: 4*Math.PI,
        linearFriction: 0.5,
        angularFriction: 1.0,
        coefficientOfRestitution: 0.0,
        sensorSpecifications: sensorConfigJson
        //startPosition: [0,0,0],
        //startRotation: [0,0,0,1]
      }];

      function mapToObject(map) {
        const obj = {};
        const keys = map.keys();
        for (let i = 0; i < keys.size(); i++) {
          const key = keys.get(i);
          const value = map.get(key);
          obj[key] = value;
        }
        return obj;
      }

      function createSensorSpec(config) {
        const converted = new Module.SensorSpec();
        for (let key in config) {
          let value = config[key];
          converted[key] = value;
        }
        return converted;
      }

      function createAgentConfig(config) {
        const converted = new Module.AgentConfiguration();
        for (let key in config) {
          let value = config[key];
          if (key === 'sensorSpecifications') {
            const sensorSpecs = new Module.VectorSensorSpec();
            for (let c of value) {
              sensorSpecs.push_back(createSensorSpec(c));
            }
            value = sensorSpecs;
          }
          converted[key] = value;
        }
        return converted;
      }

      // function updateImage(canvas, obs, x, y) {
      //   const shape = obs.getShape();
      //   console.log(shape.get(0), shape.get(1), shape.get(2), 
      //     shape.get(0)*shape.get(1)*shape.get(2));
      //   const ctx = canvas.getContext('2d');
      //   const imageData = ctx.createImageData(shape.get(0), shape.get(1));
      //   console.log(obs.getBytes());
      //   imageData.data.set(obs.getBytes());
      //   console.log(imageData);
      //   ctx.putImageData(imageData, x, y);
      // }

      // const agentConfigs = agentConfigJson.map(c => createAgentConfig(c));
      const defaultAgentConfig = new Module.AgentConfiguration();
      //const agentConfigs = [defaultAgentConfig];
      const agentConfigs = agentConfigJson.map(c => createAgentConfig(c));
      const config = new Module.SimulatorConfiguration();
      config.getScene().id = "van-gogh-room.glb";
      //config.getScene().id = "skokloster-castle.glb";
      console.log("config.scene.id", config.scene.id);

      const sim = new Module.Simulator(config);
      const agent = sim.addAgent(agentConfigs[0]);
      const specs = agent.getSensorSpecs();
      console.log(mapToObject(specs.get("rgba_camera").parameters));
      const simenv = new SimEnv(sim, 0);
      const task = new NavigateTask(simenv, {
        canvas: document.getElementById('canvas2d'),
        status: document.getElementById('status')
      });
      task.init();
      task.reset();
      // let mobs = new Module.MapStringObservation();
      // sim.reset();
      // sim.getAgentObservations(0, mobs);
      // console.log(mobs.keys().get(0));

      // const canvas = document.getElementById('canvas2d');
      // updateImage(canvas, mobs.get('rgba_camera'), 0, 0);
      // agent.act('moveForward');
      // sim.getAgentObservations(0, mobs);
      // updateImage(canvas, mobs.get('rgba_camera'), 0, 84);
      // const st = new Module.AgentState();
      // agent.getState(st);
      // console.log(st);

      window.config = config;
      window.sim = sim;
    };
  </script>
</body>

</html>
